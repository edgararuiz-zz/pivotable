---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(pivotable)
library(dplyr)
library(lubridate)
library(DBI)
library(RSQLite)

add_figure <- function(path, width = 400) {
  char_html <- paste0("<img src='", path,"' width ='", width,"px'/><br/>")
  htmltools::HTML(char_html)
}
toc <- function() {
  re <- readLines("README.Rmd")
  has_title <- as.logical(lapply(re, function(x) substr(x, 1, 2) == "##"))
  only_titles <- re[has_title]
  titles <- trimws(gsub("#", "", only_titles))
  links <- trimws(gsub("`", "", titles))
  links <- tolower(links)
  links <- trimws(gsub(" ", "-", links))
  toc_list <- lapply(
    seq_along(titles),
    function(x) {
      pad <- ifelse(substr(only_titles[x], 1, 3) == "###", "    - ", "  - ")
      paste0(pad, "[", titles[x], "](#",links[x], ")")
    }
  )
  toc_full <- paste(toc_list, collapse = "\n") 
  cat(toc_full)
}

```

# pivotable

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/edgararuiz/pivotable.svg?branch=master)](https://travis-ci.org/edgararuiz/pivotable)
[![Codecov test coverage](https://codecov.io/gh/edgararuiz/pivotable/branch/master/graph/badge.svg)](https://codecov.io/gh/edgararuiz/pivotable?branch=master)
[![CRAN status](https://www.r-pkg.org/badges/version/pivotable)](https://CRAN.R-project.org/package=pivotable)
<!-- badges: end -->

  - [Installation](#installation)
  - [Pivot table](#pivot-table)
    - [Values](#values)
    - [Rows](#rows)
    - [Columns](#columns)
    - [Pivot](#pivot)
    - [Drill](#drill)
  - [Define dimensions and measures](#define-dimensions-and-measures)
  - [Database connections](#database-connections)
  - [pivottabler](#pivottabler)

## Installation

You can install the released version of pivotable from [CRAN](https://CRAN.R-project.org) with:

``` r
# install.packages("remotes")
remotes::install_github("edgararuiz/pivotable")
```

## Pivot table

### Values

```{r}
library(dplyr)
library(pivotable)

retail_orders %>%
  values(sum(sales))
```

### Rows

```{r}
retail_orders %>%
  rows(country) %>%
  values(sum(sales)) 
```

### Columns

```{r}
retail_orders %>%
  rows(country) %>%
  columns(status) %>%
  values(sum(sales))
```

### Pivot

```{r}
retail_orders %>%
  rows(country) %>%
  columns(status) %>%
  values(sum(sales)) %>%
  pivot()
```

### Drill

```{r}
retail_orders %>%
  rows(order_date = dim_hierarchy(
    year = as.integer(format(orderdate, "%Y")),
    month = as.integer(format(orderdate, "%m"))
    )
  ) %>%
  values(sum(sales))
```

```{r}
retail_orders %>%
  rows(order_date = dim_hierarchy(
    year = as.integer(format(orderdate, "%Y")),
    month = as.integer(format(orderdate, "%m"))
    )
  ) %>%
  values(sum(sales)) %>%
  drill(order_date)
```

## Define dimensions and measures

With `pivotable`, it is possible to pre-define a set of dimensions and measures that can then be easily accesses and re-used by pivot tables.  The idea is to provide a way to centralize data definitions, which creates a consistent reporting.  

```{r}
orders <- retail_orders %>%
  dimensions(
    order_date = dim_hierarchy(
      year = as.integer(format(orderdate, "%Y")),
      month = as.integer(format(orderdate, "%m"))
    ),
    status, 
    country
  ) %>%
  measures(
    orders_qty = n(), 
    order_total = sum(sales),
    sales_qty = sum(ifelse(status %in% c("In Process", "Shipped"), 1, 0)),
    sales_total = sum(ifelse(status %in% c("In Process", "Shipped"), sales, 0))
    )
```

```{r}
orders %>%
  rows(status)
```

```{r}
orders %>%
  rows(status) %>%
  columns(order_date) %>%
  values(sales_total)
```

## Database connections

Because `pivotable` uses `dplyr` commands to create the aggregations.  This allows `pivotable` to take advantage of the same integration that `dplyr` has, such as Spark, databases and `data.table`.   

```{r}
library(DBI)
library(RSQLite)

con <- dbConnect(SQLite(), ":memory:")

tbl_sales <- copy_to(con, retail_orders)

tbl_sales %>%
  columns(status) %>%
  rows(country) %>%
  values(sum(sales, na.rm = TRUE))
```

```{r}
dbDisconnect(con)
```

## pivottabler

```{r}
pt <- orders %>%
  rows(order_date) %>%
  values(orders_qty) %>%
  to_pivottabler()

pt$asMatrix(repeatHeaders = TRUE, includeHeaders = TRUE)
```


